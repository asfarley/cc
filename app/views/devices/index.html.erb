<p style="color: green"><%= notice %></p>

<% if user_signed_in? %>
  Logged in as <%= current_user.email %> |
  <%= link_to 'Log Out', destroy_user_session_path, data: { turbo_method: :delete } %>
<% else %>
  <%= link_to 'Log In', new_user_session_path %> |
<% end %>

<% content_for :title, "Devices" %>

<!-- Add a single map container at the top -->
<div id="all_devices_map" style="height: 400px; width: 100%; margin-bottom: 30px;"></div>

<div id="devices">
  <% @devices.each do |device| %>
    <div id="<%= dom_id device %>">
      <p>
        <strong><%= device.name %></strong>
      </p>

      <% if device.state != nil %>
        <%= render device.state %>
      <% else %>
        <p>Device state is missing.</p>
      <% end %>
    </div>
    <p>
      <%= link_to "Show this device", device %>
    </p>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Create a single map for all devices
    var map = L.map('all_devices_map');
    
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    
    var markers = [];
    var bounds = L.latLngBounds();
    
    <% @devices.each do |device| %>
      <% if device.state != nil && device.state.latitude1.present? && device.state.longitude1.present? %>
        var lat = <%= device.state.latitude1 %>;
        var lng = <%= device.state.longitude1 %>;
        var latlng = L.latLng(lat, lng);
        
        // Add marker for this device
        var marker = L.marker(latlng).addTo(map);
        marker.bindPopup("<b><%= device.name %></b><br>Lat: " + lat + "<br>Lng: " + lng);
        
        // Store marker and extend bounds
        markers.push(marker);
        bounds.extend(latlng);
      <% end %>
    <% end %>
    
    // If we have any markers, fit the map to show all of them
    if (markers.length > 0) {
      map.fitBounds(bounds, { padding: [50, 50] });
    } else {
      // Default view if no markers
      map.setView([0, 0], 2);
    }
  });
</script>