# LLM CONTEXT: Rails Device Telemetry System

## ARCHITECTURE
Rails 8.0.2 app with real-time telemetry monitoring. SQLite database. Turbo Streams for live updates. Devise authentication.

## CORE MODELS
**Device**: Tracks hardware units (name, state_id). Has many device_states, commands, photographs, audio_recordings, video_recordings.
**DeviceState**: Massive telemetry snapshot (340+ fields) - GPS (2x), IMU (3x), batteries (8x), ESCs (16x), sensors, environmental, network (cell/wifi/ethernet), transponder, actuators, etc. Belongs to Device. Broadcasts Turbo Stream updates on create/update to granular partials.
**Command**: Queued commands for devices (trigger_time, command, commandtype, result, status). Belongs to Device.
**Photograph**: Images with ActiveStorage attachments. Belongs to Device.
**AudioRecording**: Audio files with ActiveStorage attachments, optional command reference. Belongs to Device. Broadcasts Turbo Stream updates.
**VideoRecording**: Video files with ActiveStorage attachments, optional command reference. Belongs to Device. Broadcasts Turbo Stream updates.
**User**: Devise + devise_token_auth for authentication.

## KEY VIEWS
**devices/index.html.erb**: Main dashboard. Leaflet map showing all devices. Turbo stream subscription. Device cards with live updates. Game controller input display.
**devices/_device_card.html.erb**: Per-device card with Stimulus controllers (device-update, device-liveness). Shows summary, photograph, audio, video, state partials.
**devices/_device_card_audio.html.erb**: Audio recording display partial for Turbo Stream updates.
**device_states/**: 20+ granular partials (_device_info, _device_location, _device_imu, _device_battery, _device_esc, _device_network, _device_environmental, etc.) for collapsible <details> sections preserving state during Turbo updates.

## CONTROLLERS
**DevicesController**: CRUD + telemetry_status JSON endpoint (returns last telemetry time, battery%).
**DeviceStatesController**: Create updates parent Device.state reference. Accepts 340+ whitelisted params.
**CommandsController**: pending_commands route.
**PhotographsController**: CRUD for images.
**AudioRecordingsController**: CRUD for audio recordings with ActiveStorage.
**VideoRecordingsController**: CRUD for video recordings with ActiveStorage.

## JAVASCRIPT/STIMULUS
- device_update_controller.js: Handles device updates via Turbo Streams
- device_liveness_controller.js: Monitors telemetry freshness (10min threshold), updates summary
- device_map_controller.js: Leaflet map integration, battery-based marker colors
- photograph_update_controller.js: Photo refresh via Turbo Streams
- devices/controller.js, devices/map.js, devices/display.js: Game controller + device utilities

## ROUTES
- Root: devices#index (authenticated), sessions#new (unauthenticated)
- Resources: devices, device_states, commands, photographs, audio_recordings, video_recordings
- API: devise_token_auth at /api/auth
- Custom: devices/:id/telemetry_status, devices/:device_id/pending_commands

## DATABASE HIGHLIGHTS
DeviceState fields include:
- Location: latitude1/2, longitude1/2, gps1/2_* (status, timestamp, satcount, altitude, speed, heading, hdop, fix_type)
- Motion: vibex/y/z, heading/roll/yaw_deg, ax1-3, ay1-3, az1-3, vx/y/z, gyro readings (recent migration)
- Batteries: battery1-8 (v, a, temp_c, percent)
- ESCs: esc1-16 (v, a, temp_c, rpm)
- Network: cell (rssi, rsrp, rsrq, sinr, network_type, ip, bytes, bps), wifi (ssid, bssid, rssi, snr, speed, channel), ethernet (mac, ip, gateway, dhcp)
- Sensors: 8x temps, 8x rangefinders, 8x load_cells, 8x current/voltage sensors, 4x heaters, geiger, color_rgb, humidity, pressure_pa, airspeed
- Actuators: digital_output1-8, analog_output1-8, hall1-8 (angle, presence), maglock, laser, headlight, spotlight
- Configuration: armed, prearmed, mode, status, version, landed, failsafe
- Text: text1-8 strings
- Recent additions: gyro readings, voltage_sensor index fix

## REAL-TIME BEHAVIOR
DeviceState#broadcast_update: On commit, updates Device.state_id, broadcasts replace_to "devices" for each section partial (info, location, imu, battery, etc.) to preserve <details> open/closed state. Client-side liveness checks via Stimulus.
AudioRecording/VideoRecording: Broadcast Turbo Stream updates to device-specific targets on create.

## AUTHENTICATION
Devise for web sessions. devise_token_auth for API (/api/auth). before_action :authenticate_user! on all controllers.

## GEMS
rails 8.0.2, turbo-rails, stimulus-rails, propshaft, puma, sqlite3, devise, devise_token_auth, jbuilder, solid_cache, solid_queue, pry.

## NOTABLE
- Device.active?: true if last state < 10min old
- Device.last_telemetry_time_h: human-readable time since last state
- Map: Leaflet with battery-based colors, popup showing device name + battery%
- Game controller: Gamepad API integration on devices index
- Photographs: Latest via Device#latest_photograph
- Audio/Video: ActiveStorage with content type validation, Turbo Stream broadcasts
- Migrations: Recent additions - gyro readings (20260124212725), voltage_sensor index fix (20260125010550), audio_recordings (20260203005821), video_recordings (20260203010000)
